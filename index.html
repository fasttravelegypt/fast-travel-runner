<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fast Travel Running Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html, body {
    margin: 0;
    background: #111;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    touch-action: manipulation;
}
canvas {
    background: #000;
    border: 2px solid #fff;
    image-rendering: optimizeSpeed;
}
</style>
</head>

<body>
<canvas id="gameCanvas"></canvas>

<script>
/* =====================================================
   GLOBAL ERROR CATCHER
===================================================== */
window.onerror = function (msg, src, line) {
    console.error("GLOBAL ERROR:", msg, "Line:", line);
    alert("Game error:\n" + msg);
    return true;
};

/* =====================================================
   CANVAS (MOBILE OPTIMIZED)
===================================================== */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const BASE_WIDTH = 360;
const BASE_HEIGHT = 640;
const DPR = Math.min(window.devicePixelRatio || 1, 2);

canvas.width = BASE_WIDTH * DPR;
canvas.height = BASE_HEIGHT * DPR;
canvas.style.width = BASE_WIDTH + "px";
canvas.style.height = BASE_HEIGHT + "px";
ctx.scale(DPR, DPR);

/* =====================================================
   CONSTANTS
===================================================== */
const GAME_SPEED = 4;
const GRAVITY = 0.7;
const JUMP_FORCE = -18;
const SECOND_JUMP_FORCE = -14;
const GROUND_Y = BASE_HEIGHT - 150;
const DEBUG_HITBOX = false;

const MAX_OBSTACLES_ON_SCREEN = 4;
const MAX_COLLECTABLES_ON_SCREEN = 2;

/* =====================================================
   SPEED
===================================================== */
let speedMultiplier = 1;
const SPEED_INCREMENT = 0.0003;
const MAX_SPEED_MULTIPLIER = 3;

/* =====================================================
   AUDIO (SAFE MOBILE)
===================================================== */
const jumpSound = new Audio("assets/jump.mp3");
const gameOverSound = new Audio("assets/gameover.mp3");
const collectSound = new Audio("assets/collect.mp3");
const obstacleScoreSound = new Audio("assets/score.mp3");
const bgmSound = new Audio("assets/bgm.mp3");
const runSound = new Audio("assets/run_sound.mp3");

bgmSound.loop = true; bgmSound.volume = 0.3;
runSound.loop = true; runSound.volume = 0.5;

function playSound(sound) {
    const s = sound.cloneNode();
    s.volume = sound.volume;
    s.play().catch(()=>{});
}

/* =====================================================
   HELPERS
===================================================== */
function safeDraw(img, x, y, w, h) {
    if (!img || !img.complete || img.naturalWidth === 0) return;
    ctx.drawImage(img, Math.round(x), Math.round(y), Math.round(w), Math.round(h));
}
function rectsOverlap(a, b) {
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
}
function drawPlayerShadow(player) {
    const factor = Math.min(Math.abs(player.y - GROUND_Y) / 120, 1);
    const radius = 20 - factor * 10;
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.beginPath();
    ctx.ellipse(player.x + player.width / 2, GROUND_Y + player.height - 10, radius, radius * 0.45, 0, 0, Math.PI * 2);
    ctx.fill();
}

/* =====================================================
   ASSETS
===================================================== */
const background = new Image();
background.src = "assets/background.png";

/* =====================================================
   COIN TYPES (RARITY)
===================================================== */
const coinTypes = [
    { src: "assets/collectable/coin5.png", score: 5, weight: 50 },
    { src: "assets/collectable/coin10.png", score: 10, weight: 20 },
    { src: "assets/collectable/coin20.png", score: 20, weight: 15 },
    { src: "assets/collectable/coin50.png", score: 50, weight: 10 },
    { src: "assets/collectable/coin100.png", score: 100, weight: 5 }
];
coinTypes.forEach(c => { c.image = new Image(); c.image.src = c.src; });

function getRandomCoinType() {
    const total = coinTypes.reduce((s,c)=>s+c.weight,0);
    let r = Math.random()*total;
    for (const c of coinTypes) {
        if (r < c.weight) return c;
        r -= c.weight;
    }
    return coinTypes[0];
}

/* =====================================================
   PLAYER FRAMES
===================================================== */
const runFrames = [], jumpFrames = [];
for (let i=1;i<=8;i++){const img=new Image();img.src=`assets/run/run_${i}.png`;runFrames.push(img);}
for (let i=1;i<=12;i++){const img=new Image();img.src=`assets/jump/jump_${i}.png`;jumpFrames.push(img);}

/* =====================================================
   PLAYER
===================================================== */
const player = {
    x: 20, y: GROUND_Y, width: 120, height: 120,
    velocityY: 0, state: "run",
    hitbox:{offsetX:60,offsetY:8,width:26,height:70},
    jumpCount:0,maxJumps:2
};

/* =====================================================
   FLOATING WORDS & SCORE PHASES
===================================================== */
const floatingWords = [
    { minSpeed: 0, words: ["Great", "Nice"] },
    { minSpeed: 1.5, words: ["Amazing", "Fantastic"] },
    { minSpeed: 2.5, words: ["Wonderful", "Unstoppable"] }
];
const scorePerPhase = [1,5,10];

let floatingTexts = [];
let floatingScores = [];

/* =====================================================
   GAME STATE
===================================================== */
let obstacles=[], collectables=[], backgroundX=0;
let score=0, gameOver=false, gameStarted=false;
let animationFrame=0, animationTimer=0;

/* =====================================================
   INPUT (TOUCH + MOUSE)
===================================================== */
function handleInput() {
    if (!gameStarted) {
        gameStarted = true;
        bgmSound.play().catch(()=>{});
        runSound.play().catch(()=>{});
        return;
    }
    if (gameOver) return location.reload();

    if (player.jumpCount < player.maxJumps) {
        player.velocityY = player.jumpCount===0?JUMP_FORCE:SECOND_JUMP_FORCE;
        player.state="jump";
        player.jumpCount++;
        playSound(jumpSound);
        runSound.pause();
    }
}
canvas.addEventListener("pointerdown", handleInput);

/* =====================================================
   UPDATE & DRAW LOOP
===================================================== */
function loop() {
    ctx.clearRect(0,0,BASE_WIDTH,BASE_HEIGHT);

    if (!gameStarted) {
        ctx.fillStyle="#fff";
        ctx.font="26px Arial";
        ctx.textAlign="center";
        ctx.fillText("Fast Travel Running Game",BASE_WIDTH/2,BASE_HEIGHT/2);
        ctx.font="18px Arial";
        ctx.fillText("Tap to Start",BASE_WIDTH/2,BASE_HEIGHT/2+30);
        requestAnimationFrame(loop);
        return;
    }

    speedMultiplier=Math.min(speedMultiplier+SPEED_INCREMENT,MAX_SPEED_MULTIPLIER);
    const speed=GAME_SPEED*speedMultiplier;

    backgroundX-=speed;
    if (backgroundX<=-BASE_WIDTH) backgroundX=0;

    player.velocityY+=GRAVITY;
    player.y+=player.velocityY;
    if (player.y>=GROUND_Y){
        player.y=GROUND_Y;
        player.velocityY=0;
        player.jumpCount=0;
        if (player.state!=="run"){player.state="run";runSound.play().catch(()=>{});}
    }

    animationTimer++;
    if(animationTimer>3){
        animationTimer=0;
        animationFrame++;
        if(player.state==="run" && animationFrame>=runFrames.length) animationFrame=0;
        if(player.state==="jump" && animationFrame>=jumpFrames.length) animationFrame=jumpFrames.length-1;
    }

    safeDraw(background,backgroundX,0,BASE_WIDTH,BASE_HEIGHT);
    safeDraw(background,backgroundX+BASE_WIDTH,0,BASE_WIDTH,BASE_HEIGHT);

    drawPlayerShadow(player);
    safeDraw(player.state==="run"?runFrames[animationFrame]:jumpFrames[animationFrame],player.x,player.y,player.width,player.height);

    ctx.fillStyle="#fff";
    ctx.font="18px Arial";
    ctx.textAlign="left";
    ctx.fillText("Score: "+score,10,30);

    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
